<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join a Game â€” NotesAreBoring</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700;800&family=JetBrains+Mono:wght@500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .play-page {
      min-height: 100vh; display: flex; align-items: center;
      justify-content: center; padding: 24px; position: relative;
    }
    .play-page::before {
      content: ''; position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
      width: 500px; height: 500px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%); pointer-events: none;
    }
    .join-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg);
      padding: 48px 40px; max-width: 440px; width: 100%; text-align: center;
      position: relative; z-index: 1; box-shadow: var(--shadow);
    }
    .join-card h1 { font-size: 1.8rem; margin-bottom: 8px; }
    .join-card .subtitle { color: var(--text-secondary); margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; text-align: left; }
    .form-label {
      display: block; font-size: 0.85rem; font-weight: 600;
      color: var(--text-secondary); margin-bottom: 6px;
    }
    .join-footer { margin-top: 24px; font-size: 0.8rem; color: var(--text-muted); }
    .waiting-state { display: none; }
    .waiting-state.active { display: block; }
    .join-state { display: block; }
    .join-state.hidden { display: none; }
    .error-msg {
      background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--wrong); padding: 10px 16px; border-radius: var(--radius-sm);
      font-size: 0.85rem; margin-bottom: 16px; display: none;
    }
    .error-msg.show { display: block; animation: shake-input 0.4s ease; }
    .pulse-ring {
      display: inline-flex; width: 80px; height: 80px; border-radius: 50%;
      background: rgba(124, 58, 237, 0.15); align-items: center;
      justify-content: center; margin: 0 auto 24px; animation: glow-pulse 2s ease infinite;
    }
    .pulse-ring-inner {
      width: 50px; height: 50px; border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    }
    .name-suggestions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .name-chip {
      background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.2);
      border-radius: 100px; padding: 4px 12px; font-size: 0.75rem; cursor: pointer;
      transition: all 0.2s ease; color: var(--text-secondary);
      font-family: var(--font-handwritten); font-weight: 600;
    }
    .name-chip:hover { background: rgba(124, 58, 237, 0.2); color: var(--text-primary); transform: scale(1.05); }
    .shake-it { animation: shake-input 0.4s ease; }
    @keyframes shake-input {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); }
    }
    .fun-fact {
      font-family: var(--font-handwritten); font-size: 1.1rem; color: var(--text-secondary);
      min-height: 50px; transition: opacity 0.3s ease;
    }
    .player-count-num {
      font-family: var(--font-mono); font-size: 2rem; font-weight: 800;
      color: var(--primary-light); display: inline-block;
      transition: transform 0.2s ease;
    }
    .player-count-num.bump { transform: scale(1.3); }
    .lobby-player {
      display: inline-block; padding: 4px 12px; margin: 4px;
      background: rgba(124, 58, 237, 0.08); border: 1px solid rgba(124, 58, 237, 0.15);
      border-radius: 100px; font-size: 0.8rem; color: var(--text-secondary);
      animation: slide-up 0.3s ease;
    }
    .btn-loading {
      pointer-events: none; opacity: 0.7;
    }
    .btn-loading::after {
      content: ''; display: inline-block; width: 16px; height: 16px;
      border: 2px solid transparent; border-top-color: white;
      border-radius: 50%; margin-left: 8px; animation: spin 0.6s linear infinite;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 480px) {
      .join-card { padding: 32px 24px; }
      .join-card h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body class="grain-overlay">

  <div class="play-page">
    <div class="join-card">

      <!-- Brand -->
      <div style="margin-bottom: 24px;">
        <a href="index.html" class="navbar-brand logo-spin" style="justify-content: center; font-size: 1.1rem;">
          <img src="notesareboring.png" alt="NotesAreBoring" class="logo-img">
        </a>
      </div>

      <!-- Error message -->
      <div class="error-msg" id="error-msg"></div>

      <!-- Join Form -->
      <div class="join-state" id="join-form">
        <h1>Join the Game</h1>
        <p class="subtitle">No signup. No app. No nonsense.<br>
          <span class="handwritten" style="color: var(--accent); font-size: 1.15rem;">just vibes and quiz questions</span>
        </p>

        <div class="form-group">
          <label class="form-label">Game Code <span class="handwritten" style="color: var(--text-muted); font-weight: 400;">(ask your teacher!)</span></label>
          <input type="text" class="input input-code" id="game-code"
                 placeholder="______" maxlength="6" inputmode="numeric"
                 oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6); this.style.borderColor = ''; hideError();">
        </div>

        <div class="form-group">
          <label class="form-label">Your Name <span class="handwritten" style="color: var(--text-muted); font-weight: 400;">(make it good, everyone will see it)</span></label>
          <input type="text" class="input input-lg" id="player-name"
                 placeholder="What should we call you?" maxlength="20"
                 oninput="this.style.borderColor = ''; hideError();">
          <div class="name-suggestions">
            <span class="name-chip" onclick="pickName('BrainiacBoss')">BrainiacBoss</span>
            <span class="name-chip" onclick="pickName('QuizKhalifa')">QuizKhalifa</span>
            <span class="name-chip" onclick="pickName('NotesNinja')">NotesNinja</span>
            <span class="name-chip" onclick="pickName('BigBrainTime')">BigBrainTime</span>
            <span class="name-chip" onclick="pickName('SleepyScholar')">SleepyScholar</span>
          </div>
        </div>

        <button class="btn btn-accent btn-lg w-full party-btn jelly-hover" id="join-btn" style="margin-top: 8px;" onclick="joinGame()">
          Let's Go! â†’
        </button>

        <div class="join-footer">
          <span class="handwritten" style="font-size: 1rem; color: var(--text-muted);">No account needed. Works on literally any device. Yes, even that old phone.</span>
        </div>
      </div>

      <!-- Waiting state -->
      <div class="waiting-state" id="waiting-state">
        <div class="pulse-ring">
          <div class="pulse-ring-inner">ðŸŽ®</div>
        </div>
        <h2 style="font-size: 1.4rem; margin-bottom: 8px;">You're in! ðŸŽ‰</h2>
        <p class="handwritten" style="color: var(--accent); font-size: 1.3rem; margin-bottom: 16px;">waiting for your teacher to hit start...</p>

        <div class="card" style="display: inline-block; padding: 12px 24px;">
          <span style="color: var(--text-muted); font-size: 0.85rem;">Playing as</span><br>
          <span style="font-family: var(--font-heading); font-weight: 700; font-size: 1.2rem;" id="display-name">â€”</span>
        </div>

        <div style="margin-top: 20px;">
          <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px;">Players in lobby</div>
          <div class="player-count-num" id="player-count">0</div>
          <div id="lobby-players" style="margin-top: 12px;"></div>
        </div>

        <div style="margin-top: 24px; padding: 16px; background: rgba(124, 58, 237, 0.05); border-radius: var(--radius-sm);">
          <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px;">While you wait...</div>
          <div class="fun-fact" id="fun-fact">Did you know? The average student checks their phone 96 times a day. At least THIS time it's educational. ðŸ“±</div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script>
    // Focus code input on load
    document.getElementById('game-code').focus();

    // Check URL for pre-filled code (e.g. /join?code=482019)
    const urlParams = new URLSearchParams(window.location.search);
    const prefilledCode = urlParams.get('code');
    if (prefilledCode) {
      document.getElementById('game-code').value = prefilledCode.replace(/[^0-9]/g, '').slice(0, 6);
      document.getElementById('player-name').focus();
    }

    function pickName(name) {
      document.getElementById('player-name').value = name;
      document.getElementById('player-name').style.borderColor = 'var(--correct)';
    }

    function showError(msg) {
      const el = document.getElementById('error-msg');
      el.textContent = msg;
      el.classList.add('show');
    }

    function hideError() {
      document.getElementById('error-msg').classList.remove('show');
    }

    const funFacts = [
      "Did you know? The average student checks their phone 96 times a day. At least THIS time it's educational. ðŸ“±",
      "Fun fact: Studies show competitive quizzes improve retention by 50%. Science says this is good for you. ðŸ§ª",
      "Hot take: Notes are just spoilers for the test. This game is the movie adaptation. ðŸŽ¬",
      "Pro tip: The faster you answer, the more points you get. Speed matters. No pressure. âš¡",
      "Rumor has it the person in 1st place gets extra credit. (We made that up. But wouldn't it be nice?) ðŸ†",
      "The longest winning streak ever recorded was 47 questions. Just saying. No pressure. ðŸ”¥",
      "Your teacher spent like 2 minutes setting this up. Give them a round of applause. ðŸ‘",
    ];
    let factIdx = 0;

    // Store game & player info
    let currentGame = null;
    let currentPlayer = null;
    let playerSubscription = null;
    let gameSubscription = null;

    async function joinGame() {
      const code = document.getElementById('game-code').value;
      const name = document.getElementById('player-name').value.trim();

      // Validate code
      if (code.length !== 6) {
        const el = document.getElementById('game-code');
        el.style.borderColor = 'var(--wrong)';
        el.classList.add('shake-it');
        setTimeout(() => el.classList.remove('shake-it'), 500);
        showError('Enter the 6-digit code your teacher gave you!');
        return;
      }

      // Validate name
      if (!name) {
        const el = document.getElementById('player-name');
        el.style.borderColor = 'var(--wrong)';
        el.classList.add('shake-it');
        setTimeout(() => el.classList.remove('shake-it'), 500);
        showError('You need a name! Pick one or make up something fun.');
        return;
      }

      // Show loading
      const btn = document.getElementById('join-btn');
      btn.classList.add('btn-loading');
      btn.textContent = 'Joining...';
      hideError();

      try {
        // Find the game by code
        currentGame = await NotesAreBoring.Games.findByCode(code);

        if (!currentGame) {
          showError("Can't find that game. Double-check the code with your teacher!");
          btn.classList.remove('btn-loading');
          btn.textContent = "Let's Go! â†’";
          return;
        }

        if (currentGame.status === 'finished') {
          showError("That game already ended. Ask your teacher to start a new one!");
          btn.classList.remove('btn-loading');
          btn.textContent = "Let's Go! â†’";
          return;
        }

        // Check if game is full
        if (currentGame.player_count >= currentGame.max_players) {
          showError("Game is full! Ask your teacher to start another one.");
          btn.classList.remove('btn-loading');
          btn.textContent = "Let's Go! â†’";
          return;
        }

        // Join the game
        currentPlayer = await NotesAreBoring.Players.join(currentGame.id, name);

        // Save to sessionStorage so we survive page refreshes
        sessionStorage.setItem('nb_game_id', currentGame.id);
        sessionStorage.setItem('nb_player_id', currentPlayer.id);
        sessionStorage.setItem('nb_player_name', name);
        sessionStorage.setItem('nb_game_code', code);

        // Show waiting state
        document.getElementById('join-form').classList.add('hidden');
        document.getElementById('waiting-state').classList.add('active');
        document.getElementById('display-name').textContent = name;

        // Load existing players
        const existingPlayers = await NotesAreBoring.Players.getLeaderboard(currentGame.id);
        const lobby = document.getElementById('lobby-players');
        const countEl = document.getElementById('player-count');
        countEl.textContent = existingPlayers.length;

        existingPlayers.forEach(p => {
          const el = document.createElement('div');
          el.className = 'lobby-player';
          el.textContent = p.nickname;
          if (p.id === currentPlayer.id) {
            el.style.border = '1px solid var(--accent)';
            el.style.background = 'rgba(236, 72, 153, 0.1)';
          }
          lobby.appendChild(el);
        });

        // Subscribe to new players joining (real-time)
        playerSubscription = NotesAreBoring.Games.subscribeToPlayers(currentGame.id, (payload) => {
          if (payload.eventType === 'INSERT' && payload.new.id !== currentPlayer.id) {
            const el = document.createElement('div');
            el.className = 'lobby-player';
            el.textContent = payload.new.nickname;
            lobby.appendChild(el);
            const count = lobby.children.length;
            countEl.textContent = count;
            countEl.classList.add('bump');
            setTimeout(() => countEl.classList.remove('bump'), 200);
          }
        });

        // Subscribe to game status changes (teacher starts game)
        gameSubscription = NotesAreBoring.Games.subscribeToGame(currentGame.id, (payload) => {
          if (payload.new.status === 'in_progress') {
            // Game started! Redirect to the live game page
            window.location.href = `game.html?game=${currentGame.id}&player=${currentPlayer.id}`;
          }
        });

        // Rotate fun facts
        setInterval(() => {
          const factEl = document.getElementById('fun-fact');
          factEl.style.opacity = '0';
          setTimeout(() => {
            factIdx = (factIdx + 1) % funFacts.length;
            factEl.textContent = funFacts[factIdx];
            factEl.style.opacity = '1';
          }, 300);
        }, 5000);

      } catch (err) {
        console.error('Join error:', err);
        showError("Something went wrong. Try again or ask your teacher for help!");
        btn.classList.remove('btn-loading');
        btn.textContent = "Let's Go! â†’";
      }
    }

    // Keyboard shortcuts
    document.getElementById('player-name').addEventListener('keydown', e => { if (e.key === 'Enter') joinGame(); });
    document.getElementById('game-code').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('player-name').focus(); });
  </script>

</body>
</html>
